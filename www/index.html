<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <!--
        Customize this policy to fit your own app's needs. For more guidance, see:
            https://github.com/apache/cordova-plugin-whitelist/blob/master/README.md#content-security-policy
        Some notes:
            * gap: is required only on iOS (when using UIWebView) and is needed for JS->native communication
            * https://ssl.gstatic.com is required only on Android and is needed for TalkBack to function properly
            * Disables use of inline scripts in order to mitigate risk of XSS vulnerabilities. To change this:
                * Enable inline JS: add 'unsafe-inline' to default-src
        -->
        <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
        <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; script-src 'self' "> -->
        <meta name="format-detection" content="telephone=no">
        <meta name="msapplication-tap-highlight" content="no">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
        <link rel="stylesheet" type="text/css" href="css/index.css">
        <script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
<script type="text/javascript">
if( location.href.indexOf('/home/') < 0 || !navigator.userAgent.toLowerCase().match('chrome') ) { document.write('<script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"><' + '/script>'); }
</script>
        <!-- <script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script> -->
        <script type="text/javascript" src="js/date.js"></script>
        <script type="text/javascript" src="js/dailylist.js"></script>
        <script type="text/javascript" src="js/ical.js"></script>
    <script type="text/javascript">
    $(function() {
    if( !$('textarea.ical').length ) {
        $('.diary').append(
            $('<textarea></textarea>')
                .addClass('ical')
                .css('position', 'fixed')
                .css('left', '110px')
                .css('right', '110px')
                .css('bottom', '15px')
                .css('z-index', '10')
                .css('width', '0')
                .css('height', '0px')
                .css('transition', 'width 1s, height 1s')
                .on(
                    'focus',
                    function() {
                        var thisObj = $(this);
                        if( thisObj.val() == '' ) {
                            thisObj
                                .css('width', '0')
                                .css('height', '0px')
                            }
                        })
                .on(
                    'blur',
                    function() {
                        var thisObj = $(this);
                        if( thisObj.val() == '' ) {
                            thisObj
                                .css('width', '0')
                                .css('height', '0px')
                            }
                        })
                );
            }
        });

    ICAL.design.components.vevent.property['x-spending'] = {"defaultType":"text"};
    ICAL.TimezonesOffsetToTZIDMap = {};

    ICAL.TimezonesOffsetToTZIDMap['+GMT0100'] = 'Europe/Madrid';
    ICAL.TimezoneService.register( 'Europe/Madrid',
        ICAL.Timezone.fromData(
            new ICAL.Component( ICAL.parse(
`BEGIN:VTIMEZONE
TZID:Europe/Madrid
BEGIN:DAYLIGHT
TZOFFSETFROM:+0100
TZOFFSETTO:+0200
TZNAME:CEST
DTSTART:19700329T020000
RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU
END:DAYLIGHT
BEGIN:STANDARD
TZOFFSETFROM:+0200
TZOFFSETTO:+0100
TZNAME:CET
DTSTART:19701025T030000
RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU
END:STANDARD
END:VTIMEZONE`))));


    function toICAL() {
        var aItems = JSON.parse( localStorage.getItem( "itemsList" ) );
        var comp = new ICAL.Component('VCALENDAR');
            comp.addPropertyWithValue('calscale','GREGORIAN');
            comp.addPropertyWithValue('prodid','-//VanGAMO//DailyListBeta//EN');
            comp.addPropertyWithValue('version','2.0');

            comp.addSubcomponent( ICAL.TimezoneService.get( 'Europe/Madrid' ).component );


        aItems.forEach( function( elem ) {
            var dailyListDate = new Date( parseInt(elem.time,10) ).setTimezone( elem.time.substring( elem.time.indexOf('+') ) );
            var dailyListTimestamp = parseInt(elem.time,10);
            var dailyListTimezone  = elem.time.substring( elem.time.indexOf('+') );

            var iCalType = 'VEVENT';
            var iCalDate = ICAL.Time.fromJSDate( dailyListDate );
            var iCalZone = ICAL.TimezoneService.get( 'Europe/Madrid' );
            var iCalCategories = '';

            iCalDate.fromUnixTime( Math.floor(dailyListTimestamp/1000) );
            iCalDate = iCalDate.convertToZone( iCalZone );

            if( 'task'    == elem.type ) { iCalType = 'VTODO'; }
            if( 'thought' == elem.type ) { iCalType = 'VJOURNAL'; }
            if( 'spending' == elem.type ) { iCalType = 'VJOURNAL'; }

            var event = new ICAL.Event( new ICAL.Component(iCalType, comp) );
            event.uid = '39029da948df93028a09b309a094f39e-000'+elem.id+'@dailyList@vangamo.xyz';
            event.summary = elem.title;
            event.startDate = iCalDate;
            event.endDate = iCalDate;
            event.component.addPropertyWithValue( 'dtstamp', iCalDate );
            event.component.addPropertyWithValue( 'sequence', '0' );

            if( 'string' == typeof elem.lists ) { iCalCategories = elem.lists; }
            if( $.isArray( elem.lists ) ) { iCalCategories = elem.lists.join(', '); }
            event.component.addPropertyWithValue( 'categories', iCalCategories );

            if( 'event' == elem.type ) {
                event.component.addPropertyWithValue( 'status', 'CONFIRMED' );
                }
            if( 'spending' == elem.type ) {
                var spendingValue = ''+elem.title;
                spendingValue = spendingValue.replace(/.*[-:]([^-:]+)/, '$1');
                event.component.addPropertyWithValue('x-spending', spendingValue.trim() );
                }

            comp.addSubcomponent(event.component);
            });  // each item

        return comp.toString();
        }



    function fromICAL( icalText ) {
        var aItems = [];

        var jcalData = ICAL.parse( icalText );
        var mainComp = new ICAL.Component(jcalData);
        delete jcalData; icalText='';

//        if( mainComp.getFirstPropertyValue('prodid') != '-//VanGAMO//DailyListBeta//EN' ) { return; }

        mainComp.getAllSubcomponents().forEach( function( component, idx, compList ) {
            if( ['vevent','vtodo','vjournal'].indexOf(component.name) >= 0 ) {
                var event = new ICAL.Event( component );

                var icalType = component.name;
                var icalTimezone = ICAL.TimezoneService.get( event.startDate.zone );
                if( !icalTimezone ) { icalTimezone = ICAL.TimezoneService.get( 'Europe/Madrid' ); }
                var icalOffset   = icalTimezone.utcOffset(event.startDate);

                var id = aItems.length;

                var timestamp    = 1000*event.startDate.toUnixTime();
                var utcZone      = '' + ( (icalOffset>=0) ? '+' : '-' ) + 'GMT';
                    utcZone     += '' + ( (Math.abs(icalOffset)/3600 < 10) ? '0' : '' ) + Math.abs(icalOffset)/3600;
                    utcZone     += '' + ( (Math.abs(icalOffset)/60 % 60 < 10) ? '0' : '' ) + Math.floor(Math.abs(icalOffset)/60 % 60);

                var elem = {};

                if( 'vevent'   == icalType ) { elem.type = 'event'; }
                if( 'vjournal' == icalType ) { elem.type = 'thought'; }
                if( 'vjournal' == icalType && null != component.getFirstPropertyValue('x-spending') ) { elem.type = 'spending'; }
                if( 'vtodo'    == icalType ) { elem.type = 'task'; }

                if( 0 == event.uid.indexOf('39029da948df93028a09b309a094f39e'+'-') ) {
                    id = parseInt( event.uid.substring(33).replace(/@dailyList@vangamo.xyz/, ''), 10 );
                    }

                elem.id = id;
                elem.app = 'DailyListBeta';
                elem.title = event.summary;
                elem.lists = !component.getFirstPropertyValue( 'categories' ) ? [] : component.getFirstPropertyValue( 'categories' ).split(', ');
                elem.time = timestamp+utcZone;
                elem.modifier = '';
                elem.periodicity = '';
                elem.status = '';

                aItems.push( elem );
                }});

        return JSON.stringify( aItems );
        }

    </script>
        <title>Daily list app</title>
    </head>
    <body>

    <div class="main">
    <div class="menu" style="display:none; height:0em;">
        <span class="menu-icon" style="">
            <div class="bar1" style=""></div>
            <div class="bar2-L" style=""></div>
            <div class="bar2-R" style=""></div>
            <div class="bar3" style=""></div>
        </span>
        <h1 style="">Daily list</h1>
        <div class="background" style="opacity:0.0; display:none;"></div>
        <div class="panel" style="width:0px; display:none;">
            <div class="lists">Lists</div>
            <div style="margin-top:0.5em;">Settings</div>
            <div style="margin-top:0.5em;">About</div>
        </div>
    </div>  <!-- .menu -->
    <div class="logBox">
        <div id="deviceready" class="blink">
            <p class="event listening">Connecting to Device</p>
            <p class="event received">Device is Ready</p>
        </div>
    </div>

    <div class="header">- Ene. 2015 -</div>

    <div class="diary">
        <div id="background-list" class="list" style="position:absolute; height: 100%; z-index: 0; overflow:hidden;">
            <div class="itemList"></div>
        </div>  <!-- .list #background-list -->

        </div>  <!-- .list -->

    </div>  <!-- .diary -->
    </div>  <!-- .main -->

    <script type="text/javascript">
        if( location.href.indexOf('/home/') < 0 ) { document.write('<script type="text/javascript" src="cordova.js"><' + '/script>'); }
    </script>
    <!-- <script type="text/javascript" src="cordova.js"></script> -->
    </body>
</html>
